#!/bin/bash

# Your webhook secret (must match ELEVENLABS_POST_SECRET in .env)
SECRET="your-webhook-secret"

# Current timestamp in seconds
TIMESTAMP=$(date +%s)

# Sample webhook payload
read -r -d '' PAYLOAD <<'EOF'
{"type": "post_call_transcription", "event_timestamp": 1743088235, "data": {"agent_id": "hTwP6TgapJKas2oJxX6d", "conversation_id": "3ySOh4E978gWEfMy7jqo", "status": "done", "transcript": [{"role": "agent", "message": "Guten Tag, mein Name ist Lisa von SpeedNetwork", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 0, "conversation_turn_metrics": null, "rag_retrieval_info": null}, {"role": "user", "message": "Hallo, ist das Aschada?", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 2, "conversation_turn_metrics": null, "rag_retrieval_info": null}, {"role": "agent", "message": "\u00c4hm, das ist nicht Aschada. Sie sprechen mit Lisa von SpeedNetwork. Wie kann ich Ihnen helfen?", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 5, "conversation_turn_metrics": {"metrics": {"convai_llm_service_ttf_sentence": {"elapsed_time": 0.5183883779682219}, "convai_llm_service_ttfb": {"elapsed_time": 0.3835314509924501}}}, "rag_retrieval_info": null}, {"role": "user", "message": "Kann ich bitte Sascha eine Nachricht hinterlassen?", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 10, "conversation_turn_metrics": null, "rag_retrieval_info": null}, {"role": "agent", "message": "Ja, nat\u00fcrlich. Aber ich muss zuerst Ihren Namen oder den Namen Ihrer Firma wissen. Was m\u00f6chten Sie ihm...", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 13, "conversation_turn_metrics": {"metrics": {"convai_llm_service_ttf_sentence": {"elapsed_time": 0.3976317640626803}, "convai_llm_service_ttfb": {"elapsed_time": 0.3435847240034491}}}, "rag_retrieval_info": null}, {"role": "user", "message": "Bin Mike.", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 19, "conversation_turn_metrics": null, "rag_retrieval_info": null}, {"role": "agent", "message": "Danke, Mike...", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 21, "conversation_turn_metrics": {"metrics": {"convai_llm_service_ttf_sentence": {"elapsed_time": 0.5254602909553796}, "convai_llm_service_ttfb": {"elapsed_time": 0.4858067020541057}}}, "rag_retrieval_info": null}, {"role": "user", "message": "Ich bin Mike und ich m\u00f6chte ihm als Nachricht hinterlassen, dass er nach Hause gehen kann. Das war's.", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 21, "conversation_turn_metrics": null, "rag_retrieval_info": null}, {"role": "agent", "message": "Vielen Dank, Mike. Ich habe Ihre Nachricht notiert, dass Herr...", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 30, "conversation_turn_metrics": {"metrics": {"convai_llm_service_ttf_sentence": {"elapsed_time": 0.8692940580658615}, "convai_llm_service_ttfb": {"elapsed_time": 0.8324175719171762}}}, "rag_retrieval_info": null}, {"role": "user", "message": "Danke, tsch\u00fcss.", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 31, "conversation_turn_metrics": null, "rag_retrieval_info": null}, {"role": "agent", "message": "Gern geschehen, Mike. Kann ich Ihnen noch mit etwas anderem helfen?...", "tool_calls": [], "tool_results": [], "feedback": null, "llm_override": null, "time_in_call_secs": 33, "conversation_turn_metrics": {"metrics": {"convai_llm_service_ttf_sentence": {"elapsed_time": 0.41048910201061517}, "convai_llm_service_ttfb": {"elapsed_time": 0.3606061489554122}}}, "rag_retrieval_info": null}], "metadata": {"start_time_unix_secs": 1743088193, "call_duration_secs": 37, "cost": 248, "deletion_settings": {"deletion_time_unix_secs": 1806160230, "deleted_logs_at_time_unix_secs": null, "deleted_audio_at_time_unix_secs": null, "deleted_transcript_at_time_unix_secs": null, "delete_transcript_and_pii": true, "delete_audio": true}, "feedback": {"overall_score": null, "likes": 0, "dislikes": 0}, "authorization_method": "signed_url", "charging": {"dev_discount": false}, "phone_call": null, "termination_reason": ""}, "analysis": {"evaluation_criteria_results": {"nachricht_hinterlassen": {"criteria_id": "nachricht_hinterlassen", "result": "success", "rationale": "The user explicitly requested to leave a message for Sascha, which the agent acknowledged and took down. The conversation confirms the user's request was fulfilled."}}, "data_collection_results": {"message": {"data_collection_id": "message", "value": "Ich bin Mike und ich m\u00f6chte ihm als Nachricht hinterlassen, dass er nach Hause gehen kann. Das war's.", "json_schema": {"type": "string", "description": "Nachricht welche vom Anrufer hinterlassen wurde", "dynamic_variable": "", "constant_value": ""}, "rationale": "Der Anrufer Mike hinterl\u00e4sst die Nachricht, dass Sascha nach Hause gehen kann."}, "Name/Firma": {"data_collection_id": "Name/Firma", "value": "Mike", "json_schema": {"type": "string", "description": "Der Name und die Firma des Anrufers", "dynamic_variable": "", "constant_value": ""}, "rationale": "Der Anrufer identifiziert sich als Mike."}, "R\u00fcckrufnummer": {"data_collection_id": "R\u00fcckrufnummer", "value": "None", "json_schema": {"type": "string", "description": "Die Telefon unter welcher zur\u00fcckgerufen werden soll", "dynamic_variable": "", "constant_value": ""}, "rationale": "The conversation does not contain a phone number to call back. The user only leaves a message for Sascha."}}, "call_successful": "success", "transcript_summary": "Lisa from SpeedNetwork spoke with Mike, who wanted to leave a message for Sascha to go home. Lisa confirmed the message and offered further assistance, but Mike declined.\n"}, "conversation_initiation_client_data": {"conversation_config_override": {"agent": {"prompt": null, "first_message": null, "language": null}, "tts": null}, "custom_llm_extra_body": {}, "dynamic_variables": {"agent_id": "hTwP6TgapJKas2oJxX6d", "called_number": "493040607008", "callerid": "4921612963110", "last_name": "Mustermann", "system__agent_id": "hTwP6TgapJKas2oJxX6d", "system__conversation_id": "3ySOh4E978gWEfMy7jqo", "system__caller_id": null, "system__called_number": null, "system__call_duration_secs": 37, "system__time_utc": "2025-03-27T15:10:30.920459+00:00"}}}}
EOF

# Calculate signature
NORMALIZED_PAYLOAD=$(echo "$PAYLOAD" | jq -c '.')
SIGNING_MESSAGE="$TIMESTAMP.$NORMALIZED_PAYLOAD"
SIGNATURE=$(echo -n "$SIGNING_MESSAGE" | openssl dgst -sha256 -hmac "$SECRET" | cut -d' ' -f2)
SIGNATURE_HEADER="t=$TIMESTAMP,v0=$SIGNATURE"

# Make the request
curl -X POST "http://localhost:3000/postcall" \
  -H "Content-Type: application/json" \
  -H "ElevenLabs-Signature: $SIGNATURE_HEADER" \
  -d "$NORMALIZED_PAYLOAD"

echo -e "\n\nSignature Details:"
echo "Timestamp: $TIMESTAMP"
echo "Normalized Payload: $NORMALIZED_PAYLOAD"
echo "Signature Header: $SIGNATURE_HEADER"